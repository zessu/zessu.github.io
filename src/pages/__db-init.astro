---
// src/pages/__db-init.astro
import { db, Post, eq } from "astro:db";
import { getCollection } from "astro:content";
import crypto from "crypto";

// This will run during the build process to seed our database
if (import.meta.env.PROD) {
  try {
    console.log("Starting database initialization...");

    const allBlogPosts = await getCollection("blog");
    console.log(`Found ${allBlogPosts.length} articles to process`);

    const allBlogHashes = allBlogPosts.map((blogPost) => {
      return crypto.createHash("sha256").update(blogPost.id).digest("hex");
    });

    const allBlogHashesResultPromises = allBlogHashes.map(async (blogHash) => {
      return await db.select().from(Post).where(eq(Post.id, blogHash));
    });

    const blogsWithExistingHashesPromise = await Promise.all(
      allBlogHashesResultPromises
    );

    const blogsIdsWithExistingHashes = blogsWithExistingHashesPromise
      .flat()
      .map((post) => {
        return post.id;
      });

    const newBlogPosts = allBlogPosts.filter((blogPost) => {
      const blogHash = crypto
        .createHash("sha256")
        .update(blogPost.id)
        .digest("hex");
      return !blogsIdsWithExistingHashes.includes(blogHash);
    });

    const newBlogPostsPromises = newBlogPosts.map(async (blogPost) => {
      const blogHash = crypto
        .createHash("sha256")
        .update(blogPost.id)
        .digest("hex");
      return db.insert(Post).values({
        id: blogHash,
        likes: 0,
        reads: 0,
      });
    });

    await Promise.all(newBlogPostsPromises);

    console.log("Database initialization complete!");
  } catch (error) {
    console.error(`Error initializing articles}`);
  }
}
---
